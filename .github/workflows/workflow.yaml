name: test deploy AKS

on:
  workflow_dispatch:

jobs:
  build:
    name: Build & push docker image
    uses: absalon-github-org/rwf/.github/workflows/python-web-api-aks-deploy.yaml@main
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}

  deploy:
    uses: absalon-github-org/rwf/.github/workflows/api-deploy-aks.yaml@main
    needs: build
    with:
      environment: ${{ github.ref_name }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
